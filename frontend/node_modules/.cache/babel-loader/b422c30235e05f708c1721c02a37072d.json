{"ast":null,"code":"import { toDisplayString as _toDisplayString, createElementVNode as _createElementVNode, withModifiers as _withModifiers, openBlock as _openBlock, createElementBlock as _createElementBlock } from \"vue\";\nconst _hoisted_1 = {\n  class: \"site-section p-4\"\n};\nconst _hoisted_2 = {\n  class: \"container\"\n};\nconst _hoisted_3 = {\n  class: \"p-4 p-md-5 mb-4 text-white rounded bg-dark\"\n};\nconst _hoisted_4 = {\n  class: \"row\"\n};\nconst _hoisted_5 = {\n  class: \"col-6 px-0 d-flex flex-column justify-content-between\"\n};\nconst _hoisted_6 = {\n  class: \"display-4 fst-italic\"\n};\nconst _hoisted_7 = {\n  class: \"lead my-3\"\n};\n\nconst _hoisted_8 = /*#__PURE__*/_createElementVNode(\"hr\", null, null, -1\n/* HOISTED */\n);\n\nconst _hoisted_9 = {\n  class: \"d-flex justify-content-between\"\n};\n\nconst _hoisted_10 = /*#__PURE__*/_createElementVNode(\"span\", null, \"Owner:\", -1\n/* HOISTED */\n);\n\nconst _hoisted_11 = {\n  class: \"d-flex justify-content-between\"\n};\n\nconst _hoisted_12 = /*#__PURE__*/_createElementVNode(\"span\", null, \"Price per hour:\", -1\n/* HOISTED */\n);\n\nconst _hoisted_13 = [\"disabled\"];\nconst _hoisted_14 = {\n  class: \"col-6\"\n};\nconst _hoisted_15 = [\"src\"];\nexport function render(_ctx, _cache, $props, $setup, $data, $options) {\n  return _openBlock(), _createElementBlock(\"div\", _hoisted_1, [_createElementVNode(\"div\", _hoisted_2, [_createElementVNode(\"div\", _hoisted_3, [_createElementVNode(\"div\", _hoisted_4, [_createElementVNode(\"div\", _hoisted_5, [_createElementVNode(\"div\", null, [_createElementVNode(\"h1\", _hoisted_6, _toDisplayString($data.currentCar.title), 1\n  /* TEXT */\n  ), _createElementVNode(\"p\", _hoisted_7, _toDisplayString($data.currentCar.description), 1\n  /* TEXT */\n  )]), _createElementVNode(\"div\", null, [_hoisted_8, _createElementVNode(\"p\", _hoisted_9, [_hoisted_10, _createElementVNode(\"span\", null, _toDisplayString($data.currentCar.owner_id), 1\n  /* TEXT */\n  )]), _createElementVNode(\"p\", _hoisted_11, [_hoisted_12, _createElementVNode(\"span\", null, _toDisplayString(_ctx.$filters.formatYoctoNearToNear($data.currentCar.price_per_hour)) + \" Ⓝ\", 1\n  /* TEXT */\n  )]), _createElementVNode(\"button\", {\n    class: \"btn btn-primary w-100\",\n    onClick: _cache[0] || (_cache[0] = _withModifiers((...args) => $options.startRentCarProcess && $options.startRentCarProcess(...args), [\"prevent\"])),\n    disabled: $data.currentCar.is_rented\n  }, \"Rent car\", 8\n  /* PROPS */\n  , _hoisted_13)])]), _createElementVNode(\"div\", _hoisted_14, [_createElementVNode(\"img\", {\n    src: $data.currentCar.image,\n    alt: \"Image\",\n    class: \"img-fluid\",\n    style: {\n      \"width\": \"100%\"\n    }\n  }, null, 8\n  /* PROPS */\n  , _hoisted_15)])])])])]);\n}","map":{"version":3,"mappings":";;EACOA,KAAK,EAAC;;;EACJA,KAAK,EAAC;;;EACJA,KAAK,EAAC;;;EACJA,KAAK,EAAC;;;EACJA,KAAK,EAAC;;;EAEHA,KAAK,EAAC;;;EACPA,KAAK,EAAC;;;gCAGTC,oBAAI,IAAJ,EAAI,IAAJ,EAAI,IAAJ,EAAI;AAAA;AAAJ;;;EACGD,KAAK,EAAC;;;iCAAiCC,oBAAmB,MAAnB,EAAmB,IAAnB,EAAM,QAAN,EAAY;AAAA;AAAZ;;;EACvCD,KAAK,EAAC;;;iCAAiCC,oBAA4B,MAA5B,EAA4B,IAA5B,EAAM,iBAAN,EAAqB;AAAA;AAArB;;;;EAIzCD,KAAK,EAAC;;;;uBAhBnBE,oBAuBM,KAvBN,cAuBM,CAtBJD,oBAqBM,KArBN,cAqBM,CApBJA,oBAkBM,KAlBN,cAkBM,CAjBJA,oBAgBM,KAhBN,cAgBM,CAfJA,oBAWM,KAXN,cAWM,CAVJA,oBAGM,KAHN,EAGM,IAHN,EAGM,CAFJA,oBAA4D,IAA5D,cAA4DE,iBAAxBC,iBAAWC,KAAa,CAA5D,EAAoD;EAAA;EAApD,CAEI,EADJJ,oBAAqD,GAArD,cAAqDE,iBAA7BC,iBAAWE,WAAkB,CAArD,EAA8C;EAAA;EAA9C,CACI,CAHN,CAUI,EANJL,oBAKM,KALN,EAKM,IALN,EAKM,CAJJM,UAII,EAHJN,oBAAqG,GAArG,cAAqG,CAA3DO,WAA2D,EAAxCP,oBAAoC,MAApC,EAAoC,IAApC,EAAoCE,iBAA5BC,iBAAWK,QAAiB,CAApC,EAA2B;EAAA;EAA3B,CAAwC,CAArG,CAGI,EAFJR,oBAAsJ,GAAtJ,eAAsJ,CAA5GS,WAA4G,EAAhFT,oBAA4E,MAA5E,EAA4E,IAA5E,EAA4EE,iBAApEQ,cAASC,qBAAT,CAA+BR,iBAAWS,cAA1C,CAAoE,IAAT,IAAnE,EAAqE;EAAA;EAArE,CAAgF,CAAtJ,CAEI,EADJZ,oBAA6H,QAA7H,EAA6H;IAArHD,KAAK,EAAC,uBAA+G;IAAtFc,OAAK,wDAAUC,qEAAV,EAA6B,WAA7B,EAAiF;IAAjDC,QAAQ,EAAEZ,iBAAWa;EAA4B,CAA7H,EAA4G,UAA5G,EAAoH;EAAA;EAApH,EAAoHC,WAApH,CACI,CALN,CAMI,CAXN,CAeI,EAHJjB,oBAEM,KAFN,eAEM,CADJA,oBAA+E,KAA/E,EAA+E;IAAzEkB,GAAG,EAAEf,iBAAWgB,KAAyD;IAAlDC,GAAG,EAAC,OAA8C;IAAtCrB,KAAK,EAAC,WAAgC;IAApBsB,KAAmB,EAAnB;MAAA;IAAA;EAAoB,CAA/E;;EAAA,cACI,CAFN,CAGI,CAhBN,CAiBI,CAlBN,CAoBI,CArBN,CAsBI,CAvBN","names":["class","_createElementVNode","_createElementBlock","_toDisplayString","$data","title","description","_hoisted_8","_hoisted_10","owner_id","_hoisted_12","_ctx","formatYoctoNearToNear","price_per_hour","onClick","$options","disabled","is_rented","_hoisted_13","src","image","alt","style"],"sourceRoot":"","sources":["/var/www/ch-8-car-renting/frontend/src/components/Pages/SingleCarComponent.vue"],"sourcesContent":["<template>\n  <div class=\"site-section p-4\">\n    <div class=\"container\">\n      <div class=\"p-4 p-md-5 mb-4 text-white rounded bg-dark\">\n        <div class=\"row\">\n          <div class=\"col-6 px-0 d-flex flex-column justify-content-between\">\n            <div>\n              <h1 class=\"display-4 fst-italic\">{{ currentCar.title }}</h1>\n              <p class=\"lead my-3\">{{ currentCar.description }}</p>\n            </div>\n            <div>\n              <hr>\n              <p class=\"d-flex justify-content-between\"><span>Owner:</span><span>{{currentCar.owner_id}}</span></p>\n              <p class=\"d-flex justify-content-between\"><span>Price per hour:</span><span>{{$filters.formatYoctoNearToNear(currentCar.price_per_hour)}} Ⓝ</span></p>\n              <button class=\"btn btn-primary w-100\" @click.prevent=\"startRentCarProcess\" :disabled=\"currentCar.is_rented\">Rent car</button>\n            </div>\n          </div>\n          <div class=\"col-6\">\n            <img :src=\"currentCar.image\" alt=\"Image\" class=\"img-fluid\" style=\"width: 100%\">\n          </div>\n        </div>\n      </div>\n\n    </div>\n  </div>\n\n\n</template>\n\n<script>\nimport Big from \"big.js\";\nimport * as nearAPI from \"near-api-js\";\nimport {getTransactionState, getUrlParams} from \"../../../helpers\";\nimport {Contract} from \"near-api-js\";\n\nconst BOATLOAD_OF_GAS = Big(3).times(10 ** 13).toFixed();\n\nexport default {\n  name: \"SingleCarComponent\",\n  components: {},\n  data() {\n    return {\n      currentCar: {},\n    }\n  },\n  methods: {\n    async getCurrentCar() {\n      const provider = new nearAPI.providers.JsonRpcProvider(window.nearConfig.nodeUrl);\n      const argsBase64 = window.btoa(JSON.stringify({id: +this.$route.params.id}))\n      const rawResult = await provider.query({\n        request_type: \"call_function\",\n        finality: \"final\",\n        account_id: window.nearConfig.contractName,\n        method_name: \"get_car_by_id\",\n        args_base64: argsBase64,\n      }).catch(() => {\n        this.$router.push({'name': 'home'});\n      });\n      this.currentCar = JSON.parse(Buffer.from(rawResult.result).toString())\n    },\n\n    async startRentCarProcess(){\n\n      let loader = this.$loading.show();\n      window.walletConnection.account().functionCall({\n        contractId: window.roketoWrapContractName,\n        methodName: 'near_deposit',\n        args: {},\n        gas:\"200000000000000\",\n        attachedDeposit:Big(((this.currentCar.price_per_hour + (0.2 * 10**24)) / (10**24)).toFixed(5)).times(10 ** 24).toFixed(),\n      }).then((response)=>{\n        console.log(response)\n      });\n      loader.hide();\n    },\n    async afterNearDeposit(){\n      let loader = this.$loading.show();\n      const ftContract = new Contract(window.walletConnection.account(), window.roketoWrapContractName, {\n        changeMethods: ['ft_transfer_call', 'near_deposit'],\n      });\n\n      const tokens_per_sec = BigInt(Big((this.currentCar.price_per_hour / 60 / 60 / (10**24)).toFixed(5)).times(10 ** 24).toFixed().toString());\n\n      await ftContract.ft_transfer_call({\n        receiver_id: window.roketoContractName,\n        amount: Big((this.currentCar.price_per_hour / (10**24)).toFixed(5)).times(10 ** 24).toFixed(), // 1 NEAR\n        memo: 'Car rent #' + +this.$route.params.id,\n        msg: JSON.stringify({\n          Create: {\n            request: {\n              \"owner_id\": window.nearAccount.accountId,\n              \"receiver_id\": this.currentCar.owner_id,\n              \"tokens_per_sec\": tokens_per_sec, // 1 month for 1 NEAR\n            }\n          }\n        }),\n      }, 200000000000000,1);\n      loader.hide();\n    },\n    cleanGetParams(){\n      window.history.pushState({}, document.title, process.env.VUE_APP_APP_URL + '#' + this.$route.fullPath);\n    },\n\n    async afterFtTransferCall(){\n      const provider = new nearAPI.providers.JsonRpcProvider(window.nearConfig.nodeUrl);\n      const argsBase64 = window.btoa(JSON.stringify({\n        account_id:window.nearAccount.accountId,\n        from:1,\n        limit:100\n      }))\n      const rawResult = await provider.query({\n        request_type: \"call_function\",\n        finality: \"final\",\n        account_id: window.roketoContractName,\n        method_name: \"get_account_outgoing_streams\",\n        args_base64: argsBase64,\n      });\n      let outgoing_streams = JSON.parse(Buffer.from(rawResult.result).toString());\n      console.log(outgoing_streams)\n      let last_stream = outgoing_streams.at(-1);\n      try {\n        await window.walletConnection.account().functionCall({\n          contractId: window.nearConfig.contractName,\n          methodName: 'rent_car',\n          args: {\n            car_id: +this.$route.params.id,\n            stream_id: last_stream.id\n          },\n          gas:BOATLOAD_OF_GAS,\n        }).then(async () => {\n          this.$swal.fire({\n            icon: 'success',\n            title: 'Success',\n            text: 'Car was rent!',\n            footer: ``,\n          })\n          this.currentCar.is_rented = true;\n          // await this.getCurrentCar();\n        });\n      } catch (error) {\n        this.$swal.fire({\n          icon: 'error',\n          title: 'Error',\n          text: error.message,\n          footer: ``,\n        })\n        console.log(error)\n      }\n    },\n\n    async continueRentCarProcess() {\n      let params = getUrlParams();\n      let transactionHashes = params.get('transactionHashes');\n      if (transactionHashes !== null){\n        let result = await getTransactionState(transactionHashes);\n        if (\"SuccessValue\" in result.status){\n          const transactionMethodName = result.transaction.actions[0].FunctionCall.method_name;\n          switch (transactionMethodName){\n            case 'near_deposit':\n              await this.afterNearDeposit();\n              this.cleanGetParams();\n              break;\n            case 'ft_transfer_call':\n              await this.afterFtTransferCall();\n              this.cleanGetParams();\n              break;\n            case 'get_account_outgoing_streams':\n              this.$swal.fire({\n                icon: 'success',\n                title: 'Success',\n                text: 'Car was rent!',\n                footer: ``,\n              })\n              this.cleanGetParams();\n              break;\n          }\n        }\n      }\n    },\n  },\n  async mounted() {\n    let loader = this.$loading.show();\n    await this.getCurrentCar();\n\n\n    const ftContract = new Contract(window.walletConnection.account(), window.roketoWrapContractName, {\n      changeMethods: ['ft_transfer_call', 'near_deposit'],\n    });\n\n    const tokens_per_sec = BigInt(Big((this.currentCar.price_per_hour / 60 / 60 / (10**24)).toFixed(5)).times(10 ** 24).toFixed().toString());\n    console.log(tokens_per_sec)\n    await ftContract.ft_transfer_call({\n      receiver_id: window.roketoContractName,\n      amount: Big((this.currentCar.price_per_hour / (10**24)).toFixed(5)).times(10 ** 24).toFixed(), // 1 NEAR\n      memo: 'Car rent #' + +this.$route.params.id,\n      msg: JSON.stringify({\n        Create: {\n          request: {\n            \"owner_id\": window.nearAccount.accountId,\n            \"receiver_id\": this.currentCar.owner_id,\n            \"tokens_per_sec\": tokens_per_sec, // 1 month for 1 NEAR\n          }\n        }\n      }),\n    }, 200000000000000,1);\n\n\n    await this.continueRentCarProcess();\n    loader.hide();\n  },\n}\n</script>\n\n<style scoped>\n\n</style>"]},"metadata":{},"sourceType":"module"}